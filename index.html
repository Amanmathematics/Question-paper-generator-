<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced Question Paper Generator</title>

<!-- Cropper.js CSS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">

<style>
    body {
        font-family: 'Times New Roman', serif;
        background: #f5f5f5;
        margin: 0;
        padding: 0;
    }
    .container {
        width: 210mm;
        min-height: 297mm;
        margin: auto;
        background: white;
        padding: 20px 30px;
        box-shadow: 0 0 10px #ccc;
        position: relative;
    }
    .header {
        text-align: center;
        position: relative;
        margin-bottom: 10px;
    }
    .header img {
        position: absolute;
        left: 30px;
        top: 5px;
        height: 90px;
        width: 90px;
        object-fit: contain;
    }
    .header h1 { font-size: 26px; margin: 0; font-weight: bold; }
    .header h2 { font-size: 18px; margin: 2px 0; font-weight: normal; }
    .header p { font-size: 14px; margin: 0; }
    #examTitle { font-size: 16px; font-style: italic; display: block; margin-top: 5px; }
    .info {
        display: flex;
        justify-content: space-between;
        font-size: 13px;
        margin-top: 8px;
        align-items: center;
    }
    .subject { font-size: 18px; font-weight: bold; flex: 1; text-align: center; }
    hr { border: 1px solid black; margin: 10px 0; }
    #questions {
        position: relative;
        z-index: 2;
    }
    .watermark {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        opacity: 0.1;
        width: 80%;
        z-index: 1;
        text-align: center;
    }
    .watermark img {
        max-width: 100%;
        height: auto;
    }
    .question {
        margin-bottom: 15px;
        font-size: 15px;
        border: 1px solid #ccc;
        padding: 10px;
        border-radius: 8px;
        background: #fafafa;
        position: relative;
        line-height: 1.5;
        white-space: pre-wrap;
    }
    .question img {
        display: block;
        margin: 10px auto;
        max-width: 200px;
        height: auto;
        filter: grayscale(100%) contrast(150%) brightness(120%);
    }
    .resize-slider { width: 100%; }
    .sub-question {
        margin-left: 25px;
        font-size: 15px;
        line-height: 1.5;
        white-space: pre-wrap;
    }
    .btn {
        background: #007BFF;
        color: white;
        padding: 10px 15px;
        border: none;
        cursor: pointer;
        margin: 5px;
        border-radius: 5px;
    }
    .btn:hover { background: #0056b3; }
    input, select, textarea { width: 80%; padding: 6px; margin-bottom: 10px; }
    textarea { 
        min-height: 60px; 
        resize: vertical; 
        font-family: inherit; 
        font-size: 15px; 
        line-height: 1.5;
        white-space: pre-wrap;
    }
    @media print {
        #input-section, .btn { display: none; }
        body { background: white; }
        .container { box-shadow: none; padding: 0; }
    }
    #cropModal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000;
    }
    #cropBox { background: white; padding: 20px; }
    #cropImage { max-width: 100%; }
</style>
</head>
<body>

<div class="container" id="printArea">
    <div class="watermark" id="watermark"></div>
    <div class="header">
        <img id="schoolLogo" src="" alt="Logo">
        <h1 id="mainSchoolName">Main School Name</h1>
        <h2 id="subSchoolName">Sub School Name</h2>
        <p id="schoolAddress">School Address</p>
        <span id="examTitle">Exam Title</span>
    </div>
    <div class="info">
        <div>
            Class: <span id="classText">____</span><br>
            Date: <span id="dateText">____</span>
        </div>
        <div class="subject" id="subjectText">Subject</div>
        <div>
            Max Marks: <span id="marksText">____</span><br>
            Time: <span id="timeText">____</span>
        </div>
    </div>
    <hr>
    <div id="questions"></div>
    <h3 style="text-align:center; margin-top:30px;">Best wishes</h3>
</div>

<div id="input-section" style="margin-top:20px;">
    <h3>Set Details</h3>
    Logo: <input type="file" id="logoUpload" accept="image/*"><br>
    Main School Name: <input type="text" id="mainSchoolNameInput"><br>
    Sub School Name: <input type="text" id="subSchoolNameInput"><br>
    Address: <input type="text" id="schoolAddressInput"><br>
    Exam Title: <input type="text" id="examTitleInput"><br>
    Class: <input type="text" id="classInput"><br>
    Date: <input type="text" id="dateInput"><br>
    Subject: <input type="text" id="subjectInput"><br>
    Max Marks: <input type="text" id="marksInput"><br>
    Time: <input type="text" id="timeInput"><br>
    
    <hr>
    <h3>Add Question</h3>
    Question: <textarea id="questionText" placeholder="Type your question..."></textarea><br>
    Sub-Questions (one per line): <textarea id="subQuestionText" placeholder="Type sub-questions here..."></textarea><br>
    Marks: <input type="number" id="questionMarks"><br>
    Diagram? <input type="file" id="diagramUpload" accept="image/*"><br>
    <button class="btn" onclick="cropAndAdd()">Crop & Add Question</button>
    
    <hr>
    Watermark: <input type="file" id="watermarkUpload" accept="image/*"><br>
    <button class="btn" onclick="downloadPDF()">Download PDF</button>
</div>

<!-- Crop Modal -->
<div id="cropModal">
    <div id="cropBox">
        <img id="cropImage" src="">
        <div style="margin-top:10px;">
            <button class="btn" onclick="applyCrop()">Apply Crop</button>
            <button class="btn" onclick="closeCrop()">Cancel</button>
        </div>
    </div>
</div>

<!-- JS Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>

<script>
let qNo = 1;
let cropper;
let currentFile;

// Auto update header
document.querySelectorAll('#mainSchoolNameInput,#subSchoolNameInput,#schoolAddressInput,#examTitleInput,#classInput,#dateInput,#subjectInput,#marksInput,#timeInput')
.forEach(input=>{
    input.addEventListener('input', ()=>{
        document.getElementById('mainSchoolName').textContent=document.getElementById('mainSchoolNameInput').value;
        document.getElementById('subSchoolName').textContent=document.getElementById('subSchoolNameInput').value;
        document.getElementById('schoolAddress').textContent=document.getElementById('schoolAddressInput').value;
        document.getElementById('examTitle').textContent=document.getElementById('examTitleInput').value;
        document.getElementById('classText').textContent=document.getElementById('classInput').value;
        document.getElementById('dateText').textContent=document.getElementById('dateInput').value;
        document.getElementById('subjectText').textContent=document.getElementById('subjectInput').value;
        document.getElementById('marksText').textContent=document.getElementById('marksInput').value;
        document.getElementById('timeText').textContent=document.getElementById('timeInput').value;
    });
});

// Logo upload
document.getElementById('logoUpload').addEventListener('change', function(){
    const file=this.files[0];
    if(file){ document.getElementById('schoolLogo').src=URL.createObjectURL(file);}
});

// Watermark upload
document.getElementById('watermarkUpload').addEventListener('change', function(){
    const file=this.files[0];
    if(file){ document.getElementById('watermark').innerHTML='<img src="'+URL.createObjectURL(file)+'">';}
});

// Cropper Modal Functions
function cropAndAdd(){
    const file=document.getElementById('diagramUpload').files[0];
    if(!file){
        addQuestion(null); return;
    }
    currentFile=file;
    const img=document.getElementById('cropImage');
    img.src=URL.createObjectURL(file);
    document.getElementById('cropModal').style.display='flex';
    cropper=new Cropper(img,{aspectRatio:NaN});
}

function applyCrop(){
    const canvas=cropper.getCroppedCanvas();
    const imgData=canvas.toDataURL('image/png');
    addQuestion(imgData);
    closeCrop();
}

function closeCrop(){
    document.getElementById('cropModal').style.display='none';
    cropper.destroy();
}

// Add Question
function addQuestion(imgData){
    const text=document.getElementById('questionText').value;
    const subText=document.getElementById('subQuestionText').value;
    const marks=document.getElementById('questionMarks').value;
    if(text.trim()===''||marks.trim()===''){alert('Enter question and marks');return;}
    
    const div=document.createElement('div');
    div.className='question';
    div.innerHTML=`<strong>Q.${qNo++}</strong> ${text.replace(/ /g,"&nbsp;").replace(/\n/g,"<br>")} <span style="float:right;">[${marks} Marks]</span>`;
    
    // Sub-questions
    if(subText.trim()!==""){
        const subs=subText.split("\n");
        subs.forEach((s,i)=>{
            if(s.trim()!==""){
                const subDiv=document.createElement('div');
                subDiv.className='sub-question';
                subDiv.innerHTML=`(${String.fromCharCode(97+i)}) ${s.replace(/ /g,"&nbsp;").replace(/\n/g,"<br>")}`;
                div.appendChild(subDiv);
            }
        });
    }

    // Diagram
    if(imgData){
        const img=document.createElement('img');
        img.src=imgData;
        img.style.width='200px';
        div.appendChild(img);
        const resize=document.createElement('input');
        resize.type='range'; resize.min=100; resize.max=400; resize.value=200;
        resize.className='resize-slider';
        resize.oninput=()=>{img.style.width=resize.value+'px';};
        div.appendChild(resize);
    }
    
    document.getElementById('questions').appendChild(div);
    document.getElementById('questionText').value='';
    document.getElementById('subQuestionText').value='';
    document.getElementById('questionMarks').value='';
    document.getElementById('diagramUpload').value='';
}

// Download PDF with A4 Size
function downloadPDF(){
    const element=document.getElementById('printArea');
    const opt = {
        margin: 0,
        filename: 'QuestionPaper.pdf',
        image: { type: 'jpeg', quality: 1 },
        html2canvas: { scale: 3 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    html2pdf().set(opt).from(element).save();
}
</script>
</body>
</html>